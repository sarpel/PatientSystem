# Clinical AI Assistant - Docker Compose Override
# Development-specific overrides that apply to docker-compose.yml
# Run with: docker-compose up

version: '3.8'

services:
  # API Service - Development Override
  api:
    build:
      target: development  # Use development stage from Dockerfile
    environment:
      # Development-specific environment variables
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - API_RELOAD=true
      - DATABASE_URL=mssql+pyodbc://localhost:1433/ClinicalAI_DEV;UID=sa;PWD=StrongPassword123!;TrustServerCertificate=yes
    volumes:
      # Mount source code for hot reloading
      - ./src:/app/src
      - ./logs:/app/logs
      - ./data:/app/data
      - ./cache:/app/cache
    ports:
      - "8000:8000"
      - "5678:5678"  # Debug port
    command: ["python", "-m", "uvicorn", "src.api.fastapi_app:app",
             "--host", "0.0.0.0", "--port", "8000", "--reload",
             "--log-level", "debug"]

  # Database - Development Override
  db:
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=StrongPassword123!
      - MSSQL_PID=Express
    ports:
      - "1433:1433"  # Expose for direct access during development
    volumes:
      - sqlserver_dev_data:/var/opt/mssql/data
      - sqlserver_dev_logs:/var/opt/mssql/log
      - ./scripts/init-database.sql:/docker-entrypoint-initdb.d/init-database.sql:ro

  # Ollama - Development Override
  ollama:
    ports:
      - "11434:11434"  # Expose for direct access
    volumes:
      - ollama_dev_data:/root/.ollama
    environment:
      - OLLAMA_ORIGINS=*
      - OLLAMA_HOST=0.0.0.0
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G
          cpus: '1'

  # Redis - Development Override
  redis:
    ports:
      - "6379:6379"  # Expose for direct access
    command: redis-server --appendonly yes
    # Remove password for development ease
    volumes:
      - redis_dev_data:/data

  # Nginx - Development Override (Optional)
  nginx:
    profiles:
      - nginx  # Only start with --profile nginx
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - api

  # Frontend Development Server
  frontend:
    profiles:
      - frontend  # Only start with --profile frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_WS_URL=ws://localhost:8000/ws
    depends_on:
      - api
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]

  # Database Management Tool (Adminer)
  adminer:
    profiles:
      - tools  # Only start with --profile tools
    image: adminer:latest
    ports:
      - "8080:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=db
    depends_on:
      - db

  # MailHog - Email Testing Service
  mailhog:
    profiles:
      - tools  # Only start with --profile tools
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    environment:
      - MH_HOSTNAME=mailhog.clinical-ai.local

  # Development Testing Service
  test-runner:
    profiles:
      - testing  # Only start with --profile testing
    build:
      context: .
      target: development
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - DATABASE_URL=mssql+pyodbc://db:1433/ClinicalAI_TEST;UID=sa;PWD=StrongPassword123!;TrustServerCertificate=yes
      - TEST_AI_RESPONSE_MOCK=true
    depends_on:
      - db
    command: ["python", "-m", "pytest", "tests/", "-v", "--cov=src", "--cov-report=html"]
    working_dir: /app

# Development-specific volumes
volumes:
  sqlserver_dev_data:
    driver: local
  sqlserver_dev_logs:
    driver: local
  ollama_dev_data:
    driver: local
  redis_dev_data:
    driver: local

# Development-specific network
networks:
  default:
    name: clinical-ai-dev-network
    driver: bridge